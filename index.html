<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Conversas Hoje</title>
  <style>
    .linha-botao {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    #verConversasBtn {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #2196F3;
      color: white;
      cursor: pointer;
    }
    #verConversasBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #finalizadasInfo {
      font-size: 16px;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f5f5f5;
      font-family: sans-serif;
      white-space: nowrap;
    }
    #increaseLimitBtn {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    #increaseLimitBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

  <!-- Novo botão + contador na direita -->
  <div class="linha-botao">
    <button id="verConversasBtn" disabled>Ver Quantidade de Conversas de Hoje</button>
    <div id="finalizadasInfo" style="display:none;"></div>
  </div>

  <!-- Botão original -->
  <button id="increaseLimitBtn" disabled>Aumentar Limite</button>

  <script>
    const API_BASE = "https://sapios.chat/api/v1";
    const X_Auth_Token = "OqzMgt-kBw_-Ub1xmr40ytrd-1LW0FXEE4oLMW8TuuG";
    const X_User_Id = "KM3EgkBEHsXiRAbKt";

    const btnVerConversas = document.getElementById("verConversasBtn");
    const infoDiv = document.getElementById("finalizadasInfo");

    async function fetchWithAuth(url, options = {}) {
      options.headers = {
        ...options.headers,
        "X-Auth-Token": X_Auth_Token,
        "X-User-Id": X_User_Id,
      };
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`Erro na requisição: ${res.status}`);
      return res.json();
    }

    async function getUserByUsername(username) {
      const data = await fetchWithAuth(`${API_BASE}/users.info?username=${encodeURIComponent(username)}`);
      if (!data.user) throw new Error("Usuário não encontrado");
      return data.user;
    }

    function isToday(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      return (
        date.getDate() === now.getDate() &&
        date.getMonth() === now.getMonth() &&
        date.getFullYear() === now.getFullYear()
      );
    }

    async function getChatsToday(agentId) {
      let closed = 0;
      let open = 0;
      let offset = 0;
      const count = 100;

      while (true) {
        const url = `${API_BASE}/livechat/rooms?agents[]=${agentId}&count=${count}&offset=${offset}`;
        const data = await fetchWithAuth(url);
        const rooms = data.rooms || [];

        rooms.forEach(room => {
          const dateToCheck = room.closedAt || room.ts;
          if (isToday(dateToCheck)) {
            if (room.open) open++;
            else closed++;
          }
        });

        if (rooms.length < count) break;
        offset += count;
      }

      return { closed, open, total: closed + open };
    }

    let agentName = null;

    // Pede o nome do agente
    window.parent.postMessage({ action: "getAgentName" }, "*");

    window.addEventListener("message", async (event) => {
      if (event.data.action === "returnAgentName") {
        agentName = event.data.agentName;
        try {
          const user = await getUserByUsername(agentName);
          btnVerConversas.disabled = false;

          btnVerConversas.addEventListener("click", async () => {
            infoDiv.style.display = "block";
            infoDiv.textContent = "Carregando...";
            const { closed, open, total } = await getChatsToday(user._id);
            infoDiv.textContent =
              `Finalizadas: ${closed} | Em aberto: ${open} | Total: ${total}`;
          });

        } catch (err) {
          infoDiv.style.display = "block";
          infoDiv.textContent = `Erro: ${err.message}`;
        }
      }
    });
  </script>
</body>
</html>
