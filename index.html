<html>
<head>
<style>
  #usernameInput {
    padding: 10px 15px;
    font-size: 16px;
    border: 2px solid #292222;
    border-radius: 6px;
    width: 190px;
    transition: border-color 0.3s;
    margin-right: 10px;
  }
  #usernameInput:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 5px #4CAF50AA;
  }
  #increaseLimitBtn {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #increaseLimitBtn:disabled {
    background-color: #8BCF8C;
    cursor: not-allowed;
  }
  #increaseLimitBtn:hover:not(:disabled) {
    background-color: #45a049;
  }
</style>
</head>
<body>

<div id="finalizadasInfo" style="margin-bottom:10px; font-weight:bold;">
  Carregando conversas finalizadas...
</div>

<button id="increaseLimitBtn" disabled="">Puxar Conversa</button>

<script>
  const API_BASE = "https://sapios.chat/api/v1";
  const X_Auth_Token = "OqzMgt-kBw_-Ub1xmr40ytrd-1LW0FXEE4oLMW8TuuG";
  const X_User_Id = "KM3EgkBEHsXiRAbKt";

  const btn = document.getElementById("increaseLimitBtn");
  const infoDiv = document.getElementById("finalizadasInfo");

  async function fetchWithAuth(url, options = {}) {
    options.headers = {
      ...options.headers,
      "X-Auth-Token": X_Auth_Token,
      "X-User-Id": X_User_Id,
    };
    const res = await fetch(url, options);
    if (!res.ok) throw new Error(`Erro na requisição: ${res.status}`);
    return res.json();
  }

  async function getUserByUsername(username) {
    const data = await fetchWithAuth(`${API_BASE}/users.info?username=${encodeURIComponent(username)}`);
    if (!data.user) throw new Error("Usuário não encontrado");
    return data.user;
  }

  async function getClosedChatsCount(agentId) {
    let total = 0;
    let offset = 0;
    const count = 100;

    while (true) {
      const url = `${API_BASE}/livechat/rooms?agents[]=${agentId}&open=false&count=${count}&offset=${offset}`;
      const data = await fetchWithAuth(url);
      const rooms = data.rooms || [];
      total += rooms.length;
      if (rooms.length < count) break;
      offset += count;
    }
    return total;
  }

  // Pedir o dado para a página mãe
  let agentName = null;
  window.parent.postMessage({ action: "getAgentName" }, "*");

  // Escutar a resposta
  window.addEventListener("message", async (event) => {
    if (event.data.action === "returnAgentName") {
      agentName = event.data.agentName;
      try {
        const user = await getUserByUsername(agentName);
        const closedCount = await getClosedChatsCount(user._id);
        infoDiv.textContent = `Conversas finalizadas por ${agentName}: ${closedCount}`;
      } catch (err) {
        infoDiv.textContent = `Erro ao buscar finalizadas: ${err.message}`;
      }
      btn.disabled = false;
    }
  });
</script>

</body>
</html>
