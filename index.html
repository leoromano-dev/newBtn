<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Conversas Finalizadas Hoje</title>
  <style>
    #finalizadasInfo {
      font-size: 16px;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f5f5f5;
      font-family: sans-serif;
    }
  
    #increaseLimitBtn {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    #increaseLimitBtn:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="finalizadasInfo">Carregando...</div>
  <button id="increaseLimitBtn" disabled>Aumentar Limite</button>

  <script>
    const API_BASE = "https://sapios.chat/api/v1";
    const X_Auth_Token = "OqzMgt-kBw_-Ub1xmr40ytrd-1LW0FXEE4oLMW8TuuG";
    const X_User_Id = "KM3EgkBEHsXiRAbKt";

    const btn = document.getElementById("increaseLimitBtn");
    const infoDiv = document.getElementById("finalizadasInfo");

    async function fetchWithAuth(url, options = {}) {
      options.headers = {
        ...options.headers,
        "X-Auth-Token": X_Auth_Token,
        "X-User-Id": X_User_Id,
      };
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`Erro na requisição: ${res.status}`);
      return res.json();
    }

    async function getUserByUsername(username) {
      const data = await fetchWithAuth(`${API_BASE}/users.info?username=${encodeURIComponent(username)}`);
      if (!data.user) throw new Error("Usuário não encontrado");
      return data.user;
    }

    function isToday(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      return (
        date.getDate() === now.getDate() &&
        date.getMonth() === now.getMonth() &&
        date.getFullYear() === now.getFullYear()
      );
    }

    async function getClosedChatsCountToday(agentId) {
      let total = 0;
      let offset = 0;
      const count = 100;

      while (true) {
        const url = `${API_BASE}/livechat/rooms?agents[]=${agentId}&open=false&count=${count}&offset=${offset}`;
        const data = await fetchWithAuth(url);
        const rooms = data.rooms || [];

        // Filtra só as de hoje
        const closedToday = rooms.filter(room => room.closedAt && isToday(room.closedAt));
        total += closedToday.length;

        if (rooms.length < count) break;
        offset += count;
      }
      return total;
    }

    // Pedir o dado para a página mãe
    let agentName = null;
    window.parent.postMessage({ action: "getAgentName" }, "*");

    // Escutar a resposta
    window.addEventListener("message", async (event) => {
      if (event.data.action === "returnAgentName") {
        agentName = event.data.agentName;
        try {
          const user = await getUserByUsername(agentName);
          const closedCountToday = await getClosedChatsCountToday(user._id);
          infoDiv.textContent = `Conversas finalizadas hoje por ${agentName}: ${closedCountToday}`;
        } catch (err) {
          infoDiv.textContent = `Erro ao buscar finalizadas: ${err.message}`;
        }
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>

